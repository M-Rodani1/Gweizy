[phases.setup]
nixPkgs = ["python311", "gcc", "gccStdenv"]

[phases.install]
cmds = [
  "echo '========================================'",
  "echo 'DIAGNOSTIC: System Info'",
  "echo '========================================'",
  "uname -a",
  "echo ''",
  "echo '========================================'",
  "echo 'DIAGNOSTIC: Searching for libgomp'",
  "echo '========================================'",
  "find /nix/store -name 'libgomp*' 2>/dev/null || echo 'No libgomp found in /nix/store'",
  "find /usr -name 'libgomp*' 2>/dev/null || echo 'No libgomp found in /usr'",
  "find /lib -name 'libgomp*' 2>/dev/null || echo 'No libgomp found in /lib'",
  "echo ''",
  "echo '========================================'",
  "echo 'DIAGNOSTIC: GCC Info'",
  "echo '========================================'",
  "which gcc || echo 'gcc not found'",
  "gcc --version || echo 'gcc version failed'",
  "echo ''",
  "echo '========================================'",
  "echo 'DIAGNOSTIC: All .so files in nix store (sample)'",
  "echo '========================================'",
  "find /nix/store -name '*.so*' 2>/dev/null | grep -i gomp | head -20 || echo 'No gomp libraries'",
  "find /nix/store -name '*.so*' 2>/dev/null | grep -i omp | head -20 || echo 'No omp libraries'",
  "echo ''",
  "echo '========================================'",
  "echo 'DIAGNOSTIC: Nix store gcc directories'",
  "echo '========================================'",
  "ls -la /nix/store/ | grep gcc | head -10 || echo 'No gcc dirs'",
  "echo ''",
  "echo '========================================'",
  "echo 'DIAGNOSTIC: Contents of gcc lib dirs'",
  "echo '========================================'",
  "for d in /nix/store/*gcc*/lib; do echo \"=== $d ===\"; ls -la \"$d\" 2>/dev/null | head -20; done || echo 'No gcc lib dirs'",
  "echo ''",
  "echo '========================================'",
  "echo 'Installing Python packages'",
  "echo '========================================'",
  "rm -rf .venv",
  "python -m venv .venv",
  ".venv/bin/pip install --no-cache-dir --upgrade pip",
  ".venv/bin/pip install --no-cache-dir -r backend/requirements.txt",
  "echo ''",
  "echo '========================================'",
  "echo 'DIAGNOSTIC: LightGBM library dependencies'",
  "echo '========================================'",
  "ldd .venv/lib/python*/site-packages/lightgbm/lib_lightgbm.so 2>/dev/null || echo 'Could not check LightGBM deps'",
  "echo ''",
  "echo '========================================'",
  "echo 'Build phase complete'",
  "echo '========================================'",
]

[variables]
LD_LIBRARY_PATH = "/nix/store"
